<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://www.gstatic.com 'unsafe-inline'; connect-src https://*.firebaseio.com https://*.googleapis.com; style-src 'self' 'unsafe-inline';">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ø£Ø¯ÙˆØ§Øª</title>
  <link rel="stylesheet" href="admin.css" />
</head>
<body>
  <header>
    <h1>ğŸ›ï¸ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª</h1>
    <p>Ø£Ø¶Ù Ø£Ø¯ÙˆØ§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø±</p>
    <p id="user-info">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...</p>
    <button onclick="logout()" id="logout-btn">ğŸ”’ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </header>

  <main>
    <section class="form-section">
      <input type="text" id="tool-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ø§Ø©" maxlength="100" />
      <input type="url" id="tool-link" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø£Ø¯Ø§Ø©" pattern="https?://.+" />
      <button onclick="addTool()" id="add-btn">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¯Ø§Ø©</button>
    </section>

    <section id="tools-preview" class="tools-container"></section>
  </main>

  <footer>
    <p>Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù†Ø´Ø± Â© 2025 - MR-PIIP_PRO</p>
  </footer>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { firebaseConfig } from './firebase-config.js';

    // ØªØ£Ù…ÙŠÙ† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    let isAuthenticated = false;
    const ADMIN_EMAIL = "ossamapiip000@gmail.com";
    const MAX_TOOL_NAME_LENGTH = 100;
    const URL_PATTERN = /^https?:\/\/.+/i;

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const userInfo = document.getElementById("user-info");
    const addBtn = document.getElementById("add-btn");
    const logoutBtn = document.getElementById("logout-btn");

    // ØªØ£Ù…ÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    function secureUI(enabled) {
      addBtn.disabled = !enabled;
      document.getElementById("tool-name").disabled = !enabled;
      document.getElementById("tool-link").disabled = !enabled;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    function validateInput(name, link) {
      if (!name || !link) return { valid: false, error: "ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„" };
      if (name.length > MAX_TOOL_NAME_LENGTH) return { valid: false, error: "Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ø§Ø© Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹" };
      if (!URL_PATTERN.test(link)) return { valid: false, error: "Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­" };
      return { valid: true };
    }

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    function sanitizeString(str) {
      return str.replace(/[<>&"']/g, char => {
        const entities = {
          '<': '&lt;',
          '>': '&gt;',
          '&': '&amp;',
          '"': '&quot;',
          "'": '&#39;'
        };
        return entities[char];
      });
    }

    // ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆÙ…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
    onAuthStateChanged(auth, user => {
      if (!user) {
        secureUI(false);
        window.location.href = "usr.html";
        return;
      }

      if (user.email !== ADMIN_EMAIL) {
        secureUI(false);
        alert("ğŸš« Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©");
        signOut(auth).then(() => {
          window.location.href = "usr.html";
        });
        return;
      }

      isAuthenticated = true;
      secureUI(true);
      userInfo.textContent = `Ù…Ø±Ø­Ø¨Ù‹Ø§ ${sanitizeString(user.email)}`;
      loadPreview();
    });

    // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    window.logout = function () {
      if (!isAuthenticated) return;
      signOut(auth).then(() => {
        isAuthenticated = false;
        window.location.href = "usr.html";
      });
    };

    // Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ø§Ø© Ø¬Ø¯ÙŠØ¯Ø©
    window.addTool = async function () {
      if (!isAuthenticated) return;

      const name = document.getElementById("tool-name").value.trim();
      const link = document.getElementById("tool-link").value.trim();
      
      const validation = validateInput(name, link);
      if (!validation.valid) {
        alert(validation.error);
        return;
      }

      try {
        await addDoc(collection(db, "tools"), {
          name: sanitizeString(name),
          link: sanitizeString(link),
          added_at: serverTimestamp(),
          added_by: auth.currentUser.email
        });
        
        document.getElementById("tool-name").value = "";
        document.getElementById("tool-link").value = "";
        alert("âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­");
        await loadPreview();
      } catch (error) {
        console.error("ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©:", error);
        alert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: " + error.message);
      }
    };

    // Ø­Ø°Ù Ø£Ø¯Ø§Ø©
    window.deleteTool = async function (id) {
      if (!isAuthenticated) return;
      
      try {
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø©ØŸ")) {
          await deleteDoc(doc(db, "tools", id));
          await loadPreview();
        }
      } catch (error) {
        console.error("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù:", error);
        alert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­Ø°Ù: " + error.message);
      }
    };

    // ØªØ¹Ø¯ÙŠÙ„ Ø£Ø¯Ø§Ø©
    window.editTool = async function (id, oldName, oldLink) {
      if (!isAuthenticated) return;

      const newName = prompt("âœï¸ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", oldName);
      const newLink = prompt("ğŸ”— Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯:", oldLink);
      
      const validation = validateInput(newName, newLink);
      if (!validation.valid) {
        alert(validation.error);
        return;
      }

      try {
        await updateDoc(doc(db, "tools", id), {
          name: sanitizeString(newName.trim()),
          link: sanitizeString(newLink.trim()),
          updated_at: serverTimestamp(),
          updated_by: auth.currentUser.email
        });
        await loadPreview();
      } catch (error) {
        console.error("ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:", error);
        alert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: " + error.message);
      }
    };

    // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    async function loadPreview() {
      if (!isAuthenticated) return;

      const previewContainer = document.getElementById("tools-preview");
      previewContainer.innerHTML = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

      try {
        const q = query(collection(db, "tools"), orderBy("added_at", "desc"));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          previewContainer.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>";
          return;
        }

        previewContainer.innerHTML = "";
        snapshot.forEach(docSnap => {
          const tool = docSnap.data();
          const id = docSnap.id;

          const div = document.createElement("div");
          div.className = "tool-card";
          div.innerHTML = `
            <h3>${sanitizeString(tool.name)}</h3>
            <a href="${sanitizeString(tool.link)}" target="_blank" rel="noopener noreferrer">Ø±Ø§Ø¨Ø· Ø§Ù„Ø£Ø¯Ø§Ø©</a><br/>
            <button onclick="editTool('${id}', '${sanitizeString(tool.name)}', '${sanitizeString(tool.link)}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button onclick="deleteTool('${id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          `;
          previewContainer.appendChild(div);
        });
      } catch (error) {
        console.error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª:", error);
        previewContainer.innerHTML = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª";
      }
    }

    // ØªØ£Ù…ÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹
    secureUI(false);
  </script>
</body>
</html>

